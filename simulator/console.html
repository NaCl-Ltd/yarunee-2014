<html>
<head>
<link href="site/stylesheets/stylesheet2.css" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script language="javascript" src="site/javascripts/lman.unminify.js"></script>

<script type="text/javascript">
  function runSpec(spec) {
    load(spec);
    run();
    expect(spec);
  }

  function expect(spec) {
    var last_data =
      $(".console").last().find(".datastack").
        last().find(".dataframe").first().html();
    puts("assert " + spec.expected_result + ", " + last_data);
    if (spec.expected_result == last_data) {
      $(".console").last().css("background-color", "green");
    } else {
      $(".console").last().css("background-color", "red");
    }
  }

  function load (spec){
    // Set globals
    state = { state : initState(), stop_reason : "TraceStep", traceval : null, faultcode : null}
    broken = false
    $("#programpane").append("<div class='console'></div>");
    puts("Test case: ");
    puts(spec.lamprogram);
    var res = parseProg(spec.program)
    if (res.error != null){
      prog = null
      updateStatus("Error: " + res.error) 
    }
    else {
      prog = res.prog
      updateStatus("Program Loaded")
    }
  }

  // Wrapper function :: String -> Prog
  function initState () {
    var o = { };
    h$runSync( h$c2( h$ap1_e
                   , h$mainZCMainziinitStateWrapper
                   , h$c1(h$ghcjszmprimZCGHCJSziPrimziJSRef_con_e, o)
                   )
             , false
             );
    return o.state
  }

  // Wrapper function :: String -> Prog
  function parseProg (s) {
    var o = { progstr: s };
    h$runSync( h$c2( h$ap1_e
                   , h$mainZCMainziloadWrapper
                   , h$c1(h$ghcjszmprimZCGHCJSziPrimziJSRef_con_e, o)
                   )
             , false
             );
    return o
  }

  // Wrapper function :: Prog -> State -> ExecStep
  function stepProg(prog, stateval, singlestep){
    var o = { prog: prog, state: stateval, singlestep: singlestep };
    h$runSync( h$c2( h$ap1_e
                   , h$mainZCMainzirunStepWrapper
                   , h$c1(h$ghcjszmprimZCGHCJSziPrimziJSRef_con_e, o)
                   )
             , false
             );
    return { state: o.state, stop_reason : o.stop_reason,
             traceval : o.traceval, faultcode : o.faultcode }
  }

  function renderState (prog, state) {
    var o = { prog: prog, state: state };
    h$runSync( h$c2( h$ap1_e
                   , h$mainZCMainzirenderStateWrapper
                   , h$c1(h$ghcjszmprimZCGHCJSziPrimziJSRef_con_e, o)
                   )
             , false
             );
    return o.html;
  }

  function runStep(){
    state = stepProg(prog, state.state, broken)
    handleReason(state)
  }

  function step(){
    broken = true
    runStep()
    updateState()
  }

  function run(){
    broken = false
    state.stop_reason = "TraceStep"
    runLoop()
  }

  function runLoop(){
    if ((state.stop_reason == "TraceStep" || state.stop_reason == "TraceTrace" )
       && ! broken){
      runStep()
      setTimeout(runLoop, 0)
    }
  }

  function breakRun(){
    broken = true
    updateStatus("Broken by user")
    updateState()
  }

  function puts(s) {
    $(".console").last().append(s + "<br/>");
  }

  function updateState(){
    puts(renderState(prog, state.state));
  }

  function updateStatus(s){
    puts("Status:" + s);
  }

  function output(v){
    puts(v);
  }

  function handleReason(){
    switch (state.stop_reason){
      case "TraceStop":
        breakRun()
        break
      case "TraceTrace":
        output(state.traceval)
        updateStatus("Running Program")
        break
      case "TraceBreak":
        breakRun()
        updateStatus("Breakpoint")
        updateState()
        break
      case "TraceStep":
        updateStatus("Running Program")
        break
      case "TraceFault":
        breakRun()
        updateState()
        updateStatus("Fault: " + state.faultcode)
        break
    }
  }

</script>
</head>
<body>
  <h3>Spec Console</h3>
      <div class="container">
        <section id="main_content">
        <div id="programpane" style="width: 100%;">
        </div>
        </section>
      </div>
      <footer>
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
      using
      <a href="http://www.haskell.org">Haskell</a>
      </footer>
</body>
<script language="javascript" src="main.js"></script>
</html>
